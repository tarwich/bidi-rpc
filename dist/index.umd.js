(function(d,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(d=typeof globalThis<"u"?globalThis:d||self,a(d.BidiRpc={}))})(this,function(d){"use strict";function a(){const e=new Array(36);for(let n=0;n<36;n++)e[n]=Math.floor(Math.random()*16);return e[14]=4,e[19]=e[19]&=~(1<<2),e[19]=e[19]|=1<<3,e[8]=e[13]=e[18]=e[23]="-",e.map(n=>n.toString(16)).join("")}const i="2.0",f=e=>e.jsonrpc===i&&typeof e.method=="string"&&Array.isArray(e.params),l=e=>({jsonrpc:i,id:e,error:{code:-32601,message:"Method not found"}}),p=(e,n)=>({jsonrpc:i,id:e,error:{code:-32603,message:"Unexpected error",data:n}}),y=(e,n)=>{const c=new Map,m=new Promise((s,t)=>{e.readyState===0?e.addEventListener("open",()=>{s()},{once:!0}):e.readyState===1?s():t(new Error("Socket is closed"))}),g=(s,t)=>{const o=a(),r=JSON.stringify({jsonrpc:i,id:o,method:s,params:t});return new Promise((u,h)=>{c.set(o,{resolve:u,reject:h}),e.send(r)})},S=new Proxy({},{get(s,t){return async(...o)=>(await m,g(String(t),o))}});return e.addEventListener("message",async s=>{try{const t=JSON.parse(s.data),o=r=>e.send(JSON.stringify({jsonrpc:i,...r}));if(t.jsonrpc!==i)return;if(f(t)){const r=n&&n[t.method];if(!r||typeof r!="function")return o(l(t.id));try{const u=await r.call(n,...t.params);return o({id:t.id,result:u})}catch(u){return o(p(t.id,u))}}else if("result"in t){const r=c.get(t.id);r&&(r.resolve(t.result),c.delete(t.id))}else if("error"in t){const r=c.get(t.id);r&&(r.reject(t.error),c.delete(t.id))}}catch(t){console.error(t),e.send(JSON.stringify({jsonrpc:i,error:{code:-32601,message:"Invalid JSON"}}))}}),S};d.makeSocketRpc=y,Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
