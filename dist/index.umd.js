(function(s,n){typeof exports=="object"&&typeof module<"u"?n(exports):typeof define=="function"&&define.amd?define(["exports"],n):(s=typeof globalThis<"u"?globalThis:s||self,n(s.BidiRpc={}))})(this,function(s){"use strict";var I=Object.defineProperty;var J=(s,n,a)=>n in s?I(s,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[n]=a;var f=(s,n,a)=>(J(s,typeof n!="symbol"?n+"":n,a),a);const n="2.0",a=e=>e.jsonrpc===n&&typeof e.method=="string"&&Array.isArray(e.params),p=e=>({jsonrpc:n,id:e,error:{code:-32601,message:"Method not found"}}),y=(e,r)=>(console.error(r),{jsonrpc:n,id:e,error:{code:-32603,message:"Unexpected error",data:r}}),v=e=>e&&e.jsonrpc===n&&typeof e.id=="string",S=e=>e&&e.jsonrpc===n&&typeof e.id=="string"&&e.error&&typeof e.error.message=="string",g=e=>e&&e.jsonrpc===n&&typeof e.id=="string"&&("value"in e||"done"in e),w=e=>e&&typeof e[Symbol.asyncIterator]=="function";class h{constructor(){f(this,"_done");f(this,"iterator");f(this,"queue",[]);f(this,"resolvers",[]);this.iterator={next:r=>this.done?Promise.resolve({value:r,done:!0}):this.queue.length>0?Promise.resolve(this.queue.shift()):new Promise(i=>{this.resolvers.push(i)})}}get done(){return this._done&&this.queue.length===0}[Symbol.asyncIterator](){return this.iterator}next(){return this.iterator.next()}push(r){if(this._done)throw new Error("Cannot push after end");this.resolvers.length>0?this.resolvers.shift()({value:r,done:!1}):this.queue.push({value:r,done:!1})}end(){if(this._done)throw new Error("Cannot end after end");this._done=!0,this.resolvers.length>0?this.resolvers.shift()({value:void 0,done:!0}):this.queue.push({value:void 0,done:!0})}}const m=e=>e.map(r=>{switch(typeof r){case"function":return{type:"function",value:String(r)};default:return{type:typeof r,value:JSON.stringify(r)}}}),b=e=>e.map(r=>{switch(r.type){case"function":const i={require,process};return new Function(...Object.keys(i),`return ${r.value}`)(...Object.values(i));case"string":case"number":case"boolean":case"object":default:return JSON.parse(r.value)}});function j(){const e=new Array(36);for(let r=0;r<36;r++)e[r]=Math.floor(Math.random()*16);return e[14]=4,e[19]=e[19]&=~(1<<2),e[19]=e[19]|=1<<3,e[8]=e[13]=e[18]=e[23]="-",e.map(r=>r.toString(16)).join("")}const O=(e,r)=>{const i=new Map,E=new Promise((c,t)=>{e.readyState===0?e.addEventListener("open",()=>{c()},{once:!0}):e.readyState===1?c():t(new Error("Socket is closed"))}),P=(c,t)=>{const d=j(),o=JSON.stringify({jsonrpc:n,id:d,method:c,params:m(t)});return new Promise((u,l)=>{i.set(d,{resolve:u,reject:l}),e.send(o)})},N=new Proxy({},{get(c,t){return async(...d)=>(await E,P(String(t),d))}});return e.addEventListener("message",async c=>{try{const t=JSON.parse(c.data),d=o=>e.send(JSON.stringify({jsonrpc:n,...o}));if(t.jsonrpc!==n)return;if(a(t)){const o=r&&r[t.method];if(!o||typeof o!="function")return d(p(t.id));try{const u=b(t.params),l=await o.call(r,...u);if(w(l)){for await(const q of l)d({id:t.id,value:q});return d({id:t.id,done:!0})}else d({id:t.id,result:l});return}catch(u){return d(y(t.id,u))}}else if(g(t)){const o=i.get(t.id);if(o){const u=o.iterableSink||new h;o.iterableSink=u,t.done?(u.end(),i.delete(t.id),o.resolve(u)):(u.push(t.value),o.resolve(u))}}else if(S(t)){const o=i.get(t.id);o&&(o.reject(t.error),i.delete(t.id))}else if(v(t)){const o=i.get(t.id);o&&(o.resolve(t.result),i.delete(t.id))}}catch(t){console.error("Error handling message",t,c.data),e.send(JSON.stringify({jsonrpc:n,error:{code:-32601,message:"Invalid JSON"}}))}}),N};s.AsyncIterableSink=h,s.makeSocketRpc=O,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
